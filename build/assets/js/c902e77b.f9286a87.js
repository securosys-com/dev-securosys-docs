"use strict";(self.webpackChunksecurosys_docs=self.webpackChunksecurosys_docs||[]).push([[79978],{7612:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"Tutorials/troubleshooting","title":"PKCS#11 - Testing and Troubleshooting","description":"Before running any test tools or scripts, configure the HSM connection","source":"@site/pkcs/Tutorials/troubleshooting.md","sourceDirName":"Tutorials","slug":"/Tutorials/troubleshooting","permalink":"/pkcs/Tutorials/troubleshooting","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1741162132000,"frontMatter":{"title":"PKCS#11 - Testing and Troubleshooting","sidebar_label":"Testing and Troubleshooting"},"sidebar":"tutorialSidebar","previous":{"title":"PKCS#11 Provider Connection Setup","permalink":"/pkcs/Tutorials/ppin_tool"},"next":{"title":"Glossary","permalink":"/pkcs/Concepts/glossary"}}');var i=t(74848),r=t(28453);const l={title:"PKCS#11 - Testing and Troubleshooting",sidebar_label:"Testing and Troubleshooting"},o="Testing and Troubleshooting",c={},d=[{value:"Guidance",id:"guidance",level:2},{value:"Connectivity Test",id:"connectivity-test",level:2},{value:"&quot;pkcs11-tool&quot; (from OpenSC package)",id:"pkcs11-tool-from-opensc-package",level:2},{value:"&quot;p11tool&quot; (GnuTLS package)",id:"p11tool-gnutls-package",level:2},{value:"Log File Analysis",id:"log-file-analysis",level:2},{value:"Error Codes",id:"error-codes",level:2}];function a(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",input:"input",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"testing-and-troubleshooting",children:"Testing and Troubleshooting"})}),"\n",(0,i.jsx)(n.p,{children:"Before running any test tools or scripts, configure the HSM connection\nsettings (primus.cfg) and fetch the permanent secret (ppin tool)."}),"\n",(0,i.jsx)(n.h2,{id:"guidance",children:"Guidance"}),"\n",(0,i.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Ensure the PKCS#11 library is correctly installed and configured."]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Verify that the PKCS#11 provider configuration file is correctly set up with the proper parameters."]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Check for any library dependencies that might be missing or outdated."]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Confirm that the HSM slot and token labels match the configuration settings."]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","In case ",(0,i.jsx)(n.code,{children:"telnet"})," is working but a ",(0,i.jsx)(n.a,{href:"../../pkcs/Tutorials/troubleshooting#connectivity-test",children:"Connectivity Test"})," with ",(0,i.jsx)(n.code,{children:"ppin -t"})," reports an error, clarify the validity of login credentials."]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Update to the latest version of the PKCS#11 provider to ensure compatibility and bug fixes."]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Check the ",(0,i.jsx)(n.a,{href:"/pkcs/Tutorials/troubleshooting#error-codes",children:"Error Codes"})," below to narrow down the problem."]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Consult the PKCS#11 provider documentation for specific troubleshooting steps."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"connectivity-test",children:"Connectivity Test"}),"\n",(0,i.jsx)(n.p,{children:"The ppin tool allows to test connectivity to all defined HSMs and\npartitions (version 1.8.1+):"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"ppin --test [--hsm hsm] [--user HSM_USERNAME]\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"Load config file: '/etc/primus/primus.cfg'\n\nhsm0: Connect to '82.197.162.10' on port 2411, firmware: RP-2.11.2-T \n    slot0 (id=2), user=DEMO-TEST: OK\n\nNumber of tested HSMs: 1 (number of partitions: 1)\nNumber of failures: 0\n"})}),"\n",(0,i.jsx)(n.h2,{id:"pkcs11-tool-from-opensc-package",children:'"pkcs11-tool" (from OpenSC package)'}),"\n",(0,i.jsx)(n.p,{children:"The pkcs11-tool from the OpenSC package (v0.19 or newer) allows to\nlist PKCS#11 slots, manage keys and many other operations on the HSM\npartition (see man pages)."}),"\n",(0,i.jsx)(n.p,{children:"The following example lists all PKCS#11 slots, showing partition\nslot/token information:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pkcs11-tool --module /usr/local/primus/lib/libprimusP11.so -L\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"Available slots:\nSlot 0 (0x2): DEMO-TEST\t\t\t\tSlot number (index), Partition name\n  token label        : DEMO-TEST\t\t\tPartition name\n  token manufacturer : Securosys SA\n  token model        : PRIMUS HSM\t\t\t\n  token flags        : login required, rng, token initialized, PIN initialized, \n                        other flags=0x860\n  hardware version   : 2.11\t\t\t\tHSM version\n  firmware version   : 2.1\t\t\t\tProvider version\n  serial num         : a7176edc3c192207\t\tPartition serial number (within cluster)\n  pin min/max        : 0/32\n"})}),"\n",(0,i.jsx)(n.p,{children:"Login and list objects in slot 0:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pkcs11-tool --module /usr/local/primus/lib/libprimusP11.so --slot 0 -l -p '<pkcs#11_pwd>' -O\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"Certificate Object; type = X.509 cert\n  label:      MS-PrimusByokECP384\nSecret Key Object; AES length 16\n  VALUE:      1d84346b4daa61c15bc040892aaaa79e\n  label:      MS-PrimusByokAES128\n  Usage:      encrypt, decrypt, verify, wrap, unwrap\nPublic Key Object; EC  EC_POINT 384 bits\n...\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"The pkcs11-tool test function (-t) is not recommended and may fail due to incompatibilities."})}),"\n",(0,i.jsx)(n.h2,{id:"p11tool-gnutls-package",children:'"p11tool" (GnuTLS package)'}),"\n",(0,i.jsx)(n.p,{children:"The p11tool from the GnuTLS package also allows similar operations as\npkcs11-tool on PKCS#11 tokens (see man pages). The following example\nlists the available tokens:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"p11tool --list-tokens\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"Token 0:\n\tURL: pkcs11:model=Primus%20HSM;manufacturer=Securosys%20SA;serial=a7176edc3c192207;\n            token=DEMO-TEST\n\tLabel: DEMO-TEST\n\tType: Hardware token\n\tManufacturer: Securosys SA\n\tModel: Primus HSM\n\tSerial: a7176edc3c192207\n...\n"})}),"\n",(0,i.jsx)(n.p,{children:"The following example lists all objects on partition DEMO-TEST:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'p11tool --login --list-all "pkcs11:token=DEMO-TEST"\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"Token 'DEMO-TEST' with URL 'pkcs11:model=Primus%20HSM;manufacturer=Securosys%20SA;serial=a7176edc3c192207;token=DEMO-TEST' requires user PIN\nEnter PIN: <PKCS#11 password>\nObject 0:\n\tURL: pkcs11:model=Primus%20HSM;manufacturer=Securosys%20SA;serial=a7176edc3c192207;\n            token=DEMO-TEST;object=MS-PrimusByokECP384;type=cert\n\tType: X.509 Certificate\n\tLabel: MS-PrimusByokECP384\n\tFlags: CKA_TRUSTED; \n\tID: 35:69\n\nObject 1:\n\tURL: pkcs11:model=Primus%20HSM;manufacturer=Securosys%20SA;serial=a7176edc3c192207;\n            token=DEMO-TEST;object=MS-PrimusByokAES128;type=secret-key\n\tType: Secret key\n\tLabel: MS-PrimusByokAES128\n\tFlags: CKA_WRAP/UNWRAP; CKA_PRIVATE; \n\tID: 81:15\n...\n"})}),"\n",(0,i.jsx)(n.h2,{id:"log-file-analysis",children:"Log File Analysis"}),"\n",(0,i.jsx)(n.p,{children:"The provider log file can be found (as configured in primus.cfg) at\nfollowing default locations"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Linux: /tmp/primus.log"}),"\n",(0,i.jsx)(n.li,{children:"Windows: %PUBLIC%\\Securosys\\Primus P11\\primus.log"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"For troubleshooting we recommend the following temporary log settings\nin primus.cfg log section:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-libconfig",children:"    trace_linenumber    = false;\n    trace_timestamp     = true;\n    trace_function      = true;\n    trace_inout         = false;\n    trace_pid           = true;\n    trace_filename      = false;\n    trace_mask          = 0x01;\n    trace_level         = 6;\n"})}),"\n",(0,i.jsx)(n.p,{children:"Note, that the configuration is loaded only when initializing the\nlibrary (C_Initialize())."}),"\n",(0,i.jsx)(n.p,{children:"Below is an example of a log file snippet, showing a failure on\nC_GetSlotInfo(), using pkcs-11tool, due to missing HSM connectivity:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"// highlight-next-line-note\nTime-stamp              - Called from      trace_level - function       - log comment\n\n// highlight-next-line-tip\n2021-04-07 21:30:20.936 - pkcs11-tool[74481:74481] - 5 - C_Initialize() - rv: 0x0\n2021-04-07 21:30:20.936 - pkcs11-tool[74481:74481] - 6 - C_GetSlotInfo() - slotId: 0\n2021-04-07 21:30:20.936 - pkcs11-tool[74481:74481] - 6 - C_GetSlotInfo() - pInfo: 0x5509B3C0\n2021-04-07 21:30:20.936 - pkcs11-tool[74481:74481] - 6 - connectHSM() - Connecting to HSM 'hsm0'\n// highlight-next-line-warning\n2021-04-07 21:30:20.972 - pkcs11-tool[74481:74481] - 3 - HSM_Hello() - rv: 0x8000004e\n2021-04-07 21:30:20.972 - pkcs11-tool[74481:74481] - 4 - connectHSM() - Failed to login on HSM 82.197.162.10:2415 (slot: 0)\n2021-04-07 21:30:20.972 - pkcs11-tool[74481:74481] - 6 - connectHSM() - Connecting to HSM 'hsm0'\n2021-04-07 21:30:31.838 - pkcs11-tool[74481:74481] - 4 - receive() - receive failed errno 104l\n2021-04-07 21:30:31.839 - pkcs11-tool[74481:74481] - 4 - receiveAnswer() - rcv failed errno 104l\n// highlight-next-line-warning\n2021-04-07 21:30:31.839 - pkcs11-tool[74481:74481] - 3 - HSM_Hello() - rv: 0x5\n2021-04-07 21:30:31.839 - pkcs11-tool[74481:74481] - 4 - connectHSM() - Failed to login on HSM 82.197.162.10:2415 (slot: 0)\n// highlight-next-line-warning\n2021-04-07 21:30:31.839 - pkcs11-tool[74481:74481] - 3 - C_GetSlotInfo() - rv: 0xe0\n"})}),"\n",(0,i.jsx)(n.p,{children:"The errors are logged with trace_level 3. The PKCS#11 library\nfunctions start with 'C_'. The library internal HSM functions start\nwith 'HSM_'. Return value of the functions are logged in the comment\nwith 'rv: ...'."}),"\n",(0,i.jsxs)(n.p,{children:["In addition, you can also consult the ",(0,i.jsx)(n.a,{href:"/pkcs/Tutorials/ppin_tool#fetch-partition-log",children:"HSM user log"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"error-codes",children:"Error Codes"}),"\n",(0,i.jsx)(n.p,{children:"The table below lists some error codes of the Securosys provider (in\nthe log file) or the ppin tool:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Error Code"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.em,{children:"0x0nnnnnnn"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.em,{children:"Default PKCS#11 failure (see OASIS PKCS#11 standard or  pkcs11.h file)"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.em,{children:"0x8nnnnnnn"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.em,{children:"Securosys specific errors"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000001"}),(0,i.jsx)(n.td,{children:"Unexpected data type"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000002"}),(0,i.jsx)(n.td,{children:"Buffer too small"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000003"}),(0,i.jsx)(n.td,{children:"Duplicate entry"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000004"}),(0,i.jsx)(n.td,{children:"No more keys"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000005"}),(0,i.jsx)(n.td,{children:"Public key not found"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000006"}),(0,i.jsx)(n.td,{children:"Private key not found"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000008"}),(0,i.jsx)(n.td,{children:"Invalid block cipher"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000009"}),(0,i.jsx)(n.td,{children:"Invalid mechanism"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x8000000A"}),(0,i.jsx)(n.td,{children:"Object not found"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x8000000B"}),(0,i.jsx)(n.td,{children:"Login failed, wrong PKCS#11 PIN"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x8000000C"}),(0,i.jsx)(n.td,{children:"User not logged in"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x8000000D"}),(0,i.jsx)(n.td,{children:"User not found"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x8000000E"}),(0,i.jsx)(n.td,{children:"Wrong password for the key (e.g. keys created with password by JCE or CNG provider)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000012"}),(0,i.jsx)(n.td,{children:"Key not found"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000018"}),(0,i.jsx)(n.td,{children:"Max Connections exceeded"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x8000002A"}),(0,i.jsx)(n.td,{children:"Key import not allowed"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000037"}),(0,i.jsx)(n.td,{children:"Password expired"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x8000003B"}),(0,i.jsx)(n.td,{children:"Connect Timeout"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000058"}),(0,i.jsx)(n.td,{children:"EC Curve Unknown"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x8000005F"}),(0,i.jsx)(n.td,{children:"Session objects disabled by HSM configuration"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000069"}),(0,i.jsx)(n.td,{children:"Access to partition disabled by HSM configuration"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000084"}),(0,i.jsx)(n.td,{children:"DL Group unknown"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80000085"}),(0,i.jsx)(n.td,{children:"PQC mode unknown"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005001"}),(0,i.jsx)(n.td,{children:"No HSM/User configured"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005002"}),(0,i.jsx)(n.td,{children:"HSM/User configuration already exists"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005003"}),(0,i.jsx)(n.td,{children:"Primus configuration file not found"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005004"}),(0,i.jsx)(n.td,{children:"Primus secrets file not found"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005005"}),(0,i.jsx)(n.td,{children:"Invalid Primus configuration file"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005006"}),(0,i.jsx)(n.td,{children:"Invalid Primus secrets file"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005007"}),(0,i.jsx)(n.td,{children:"No write access to Primus secrets file"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005008"}),(0,i.jsx)(n.td,{children:"Failed to add permanent secret to secrets file"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005009"}),(0,i.jsx)(n.td,{children:"Invalid secrets file configuration element"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005010"}),(0,i.jsx)(n.td,{children:"Failed to update Primus secrets file"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005011"}),(0,i.jsx)(n.td,{children:"Failed to remove permanent secret from Primus secrets file"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005012"}),(0,i.jsx)(n.td,{children:"User not found in Primus configuration file"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005013"}),(0,i.jsx)(n.td,{children:"Unsupported secret types"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005014"}),(0,i.jsx)(n.td,{children:"NULL list pointer"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005015"}),(0,i.jsx)(n.td,{children:"Connection to HSM failed (network level, IP not reachable)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005017"}),(0,i.jsx)(n.td,{children:"Login to HSM failed with provided credentials (Setup Password)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005018"}),(0,i.jsx)(n.td,{children:"Setup password expired"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0x80005019"}),(0,i.jsx)(n.td,{children:"Access to partition disabled by HSM configuration"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.em,{children:"0xCnnnnnnn"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.em,{children:"HSM system errors"})})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>o});var s=t(96540);const i={},r=s.createContext(i);function l(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);
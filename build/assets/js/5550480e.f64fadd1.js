"use strict";(self.webpackChunksecurosys_docs=self.webpackChunksecurosys_docs||[]).push([[4015],{28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>a});var t=i(96540);const r={},s=t.createContext(r);function o(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(s.Provider,{value:n},e.children)}},65537:(e,n,i)=>{i.d(n,{A:()=>v});var t=i(96540),r=i(34164),s=i(65627),o=i(56347),a=i(50372),l=i(30604),c=i(11861),d=i(78749);function u(e){return t.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,t.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function p(e){const{values:n,children:i}=e;return(0,t.useMemo)((()=>{const e=n??function(e){return u(e).map((e=>{let{props:{value:n,label:i,attributes:t,default:r}}=e;return{value:n,label:i,attributes:t,default:r}}))}(i);return function(e){const n=(0,c.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,i])}function h(e){let{value:n,tabValues:i}=e;return i.some((e=>e.value===n))}function f(e){let{queryString:n=!1,groupId:i}=e;const r=(0,o.W6)(),s=function(e){let{queryString:n=!1,groupId:i}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!i)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return i??null}({queryString:n,groupId:i});return[(0,l.aZ)(s),(0,t.useCallback)((e=>{if(!s)return;const n=new URLSearchParams(r.location.search);n.set(s,e),r.replace({...r.location,search:n.toString()})}),[s,r])]}function m(e){const{defaultValue:n,queryString:i=!1,groupId:r}=e,s=p(e),[o,l]=(0,t.useState)((()=>function(e){let{defaultValue:n,tabValues:i}=e;if(0===i.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!h({value:n,tabValues:i}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${i.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const t=i.find((e=>e.default))??i[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:s}))),[c,u]=f({queryString:i,groupId:r}),[m,g]=function(e){let{groupId:n}=e;const i=function(e){return e?`docusaurus.tab.${e}`:null}(n),[r,s]=(0,d.Dv)(i);return[r,(0,t.useCallback)((e=>{i&&s.set(e)}),[i,s])]}({groupId:r}),S=(()=>{const e=c??m;return h({value:e,tabValues:s})?e:null})();(0,a.A)((()=>{S&&l(S)}),[S]);return{selectedValue:o,selectValue:(0,t.useCallback)((e=>{if(!h({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);l(e),u(e),g(e)}),[u,g,s]),tabValues:s}}var g=i(9136);const S={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=i(74848);function x(e){let{className:n,block:i,selectedValue:t,selectValue:o,tabValues:a}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,s.a_)(),d=e=>{const n=e.currentTarget,i=l.indexOf(n),r=a[i].value;r!==t&&(c(n),o(r))},u=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const i=l.indexOf(e.currentTarget)+1;n=l[i]??l[0];break}case"ArrowLeft":{const i=l.indexOf(e.currentTarget)-1;n=l[i]??l[l.length-1];break}}n?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":i},n),children:a.map((e=>{let{value:n,label:i,attributes:s}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:t===n?0:-1,"aria-selected":t===n,ref:e=>{l.push(e)},onKeyDown:u,onClick:d,...s,className:(0,r.A)("tabs__item",S.tabItem,s?.className,{"tabs__item--active":t===n}),children:i??n},n)}))})}function y(e){let{lazy:n,children:i,selectedValue:s}=e;const o=(Array.isArray(i)?i:[i]).filter(Boolean);if(n){const e=o.find((e=>e.props.value===s));return e?(0,t.cloneElement)(e,{className:(0,r.A)("margin-top--md",e.props.className)}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:o.map(((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==s})))})}function j(e){const n=m(e);return(0,b.jsxs)("div",{className:(0,r.A)("tabs-container",S.tabList),children:[(0,b.jsx)(x,{...n,...e}),(0,b.jsx)(y,{...n,...e})]})}function v(e){const n=(0,g.A)();return(0,b.jsx)(j,{...e,children:u(e.children)},String(n))}},79329:(e,n,i)=>{i.d(n,{A:()=>o});i(96540);var t=i(34164);const r={tabItem:"tabItem_Ymn6"};var s=i(74848);function o(e){let{children:n,hidden:i,className:o}=e;return(0,s.jsx)("div",{role:"tabpanel",className:(0,t.A)(r.tabItem,o),hidden:i,children:n})}},90972:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>u});const t=JSON.parse('{"id":"ossl-legacy/Installation/configuration","title":"Configure OpenSSL v1.1 for PKCS#11","description":"Discover OpenSSL\'s PKCS11 provider, CLI commands, installation tips, and troubleshooting. Integrate seamlessly with HSM for enhanced security.","source":"@site/openssl/ossl-legacy/Installation/configuration.md","sourceDirName":"ossl-legacy/Installation","slug":"/ossl-legacy/Installation/configuration","permalink":"/openssl/ossl-legacy/Installation/configuration","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1741162132000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Configure OpenSSL v1.1 for PKCS#11","sidebar_label":"Configuration","description":"Discover OpenSSL\'s PKCS11 provider, CLI commands, installation tips, and troubleshooting. Integrate seamlessly with HSM for enhanced security.","keywords":["OpenSSL PKCS11 provider","OpenSSL PKCS11 API","OpenSSL command line utility (CLI)","OpenSSL CLI commands","OpenSSL installation guide","OpenSSL installation troubleshooting","OpenSSL troubleshooting tips","OpenSSL certificate management","OpenSSL certificate creation","OpenSSL certificate renewal","OpenSSL configuration file","OpenSSL configuration options","OpenSSL configuration guide","OpenSSL encryption algorithms","OpenSSL decryption methods","OpenSSL digital signatures","OpenSSL SSL/TLS protocols","OpenSSL SSL/TLS configuration","OpenSSL heartbleed vulnerability","OpenSSL security updates"]},"sidebar":"openssl","previous":{"title":"Installation","permalink":"/openssl/ossl-legacy/Installation/"},"next":{"title":"Tutorial","permalink":"/openssl/category/tutorial-2"}}');var r=i(74848),s=i(28453),o=i(65537),a=i(79329);const l={sidebar_position:3,title:"Configure OpenSSL v1.1 for PKCS#11",sidebar_label:"Configuration",description:"Discover OpenSSL's PKCS11 provider, CLI commands, installation tips, and troubleshooting. Integrate seamlessly with HSM for enhanced security.",keywords:["OpenSSL PKCS11 provider","OpenSSL PKCS11 API","OpenSSL command line utility (CLI)","OpenSSL CLI commands","OpenSSL installation guide","OpenSSL installation troubleshooting","OpenSSL troubleshooting tips","OpenSSL certificate management","OpenSSL certificate creation","OpenSSL certificate renewal","OpenSSL configuration file","OpenSSL configuration options","OpenSSL configuration guide","OpenSSL encryption algorithms","OpenSSL decryption methods","OpenSSL digital signatures","OpenSSL SSL/TLS protocols","OpenSSL SSL/TLS configuration","OpenSSL heartbleed vulnerability","OpenSSL security updates"]},c="Configuration",d={},u=[{value:"p11-kit configuration",id:"p11-kit-configuration",level:2},{value:"Application configuration",id:"application-configuration",level:2},{value:"HMS Key Reference",id:"hms-key-reference",level:2}];function p(e){const n={admonition:"admonition",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"configuration",children:"Configuration"})}),"\n",(0,r.jsx)(n.h2,{id:"p11-kit-configuration",children:"p11-kit configuration"}),"\n",(0,r.jsx)(n.p,{children:"Each configured PKCS#11 module has its own configuration\nfile. Depending on the OS, these configuration files may reside at the\nfollowing locations:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"the p11-kit installation folder (modules folder)"}),"\n",(0,r.jsx)(n.li,{children:"/etc/pkcs11/ folder (modules folder)"}),"\n",(0,r.jsx)(n.li,{children:".pkcs11/modules folder."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Each user can optionally provide additional configuration or override\nthe system configuration. Note that user configuration files are not\nloaded from the home directory if running inside a setuid or setgid\nprogram"}),"\n",(0,r.jsx)(n.p,{children:"Create the file primus.module for your OS in"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"RHEL"}),(0,r.jsx)(n.th,{children:"Ubuntu/Debian"})]})}),(0,r.jsx)(n.tbody,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.em,{children:"/etc/pkcs11/modules/"})," or",(0,r.jsx)("br",{}),(0,r.jsx)(n.em,{children:"/usr/share/p11-kit/modules/"})]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.em,{children:"/usr/share/p11-kit/modules/"})})]})})]}),"\n",(0,r.jsx)(n.p,{children:"containing the following lines:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:"# This file describes how to load the primus pkcs11 provider module\n# For details see p11-kit and pkcs11.conf \n# and https://p11-glue.github.io/p11-glue/p11-kit/manual/\n# This is a relative path, which means it will be loaded from\n# the p11-kit default path which is usually $(libdir)/pkcs11.\n# Doing it this way allows for packagers to package primus for\n# 32-bit and 64-bit and make them parallel installable\n# highlight-info-start\nmodule: libprimusP11.so\nmanaged: true\npriority: 2\n# highlight-info-end\n#critical: true\n# A comma and/or space separated list of names of programs that this module should only\n# be loaded in. The module will not be loaded for other programs using p11-kit. The base\n# name of the process executable should be used here, for example seahorse, ssh.\n# do not use enable-in and disable-in simultaneously\n# highlight-next-line-info\nenable-in: p11-kit, openssl, httpd, nginx\n#disable-in:\n#remote:\n#log-calls: true\n"})}),"\n",(0,r.jsx)(n.p,{children:"Add a symbolic link for libprimusP11.so module in"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"RHEL"}),(0,r.jsx)(n.th,{children:"Ubuntu/Debian"})]})}),(0,r.jsx)(n.tbody,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.em,{children:"/usr/lib64/pkcs11/"})," ",(0,r.jsx)("br",{})," ",(0,r.jsx)(n.em,{children:"/usr/lib64/"})]}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.em,{children:"/usr/lib/x86_64-linux-gnu/pkcs11/"})," ",(0,r.jsx)("br",{}),"  ",(0,r.jsx)(n.em,{children:"/usr/lib/x86_64-linux-gnu/"})]})]})})]}),"\n",(0,r.jsx)(n.p,{children:"e.g. for RHEL 8:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo ln -s /usr/local/primus/lib/libprimusP11.so /usr/lib64/pkcs11/libprimusP11.so\nsudo ln -s /usr/local/primus/lib/libprimusP11.so /usr/lib64/libprimusP11.so\n"})}),"\n",(0,r.jsx)(n.p,{children:"Use the following command to check that Primus HSM module is registered:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"p11-kit list-modules\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:"// highlight-start\nprimus: libprimusP11.so\n    library-description: PKCS#11 Library\n    library-manufacturer: Securosys SA\n    library-version: 2.1\n    token: DEMO-TEST\n        manufacturer: Securosys SA\n        model: Primus HSM\n        serial-number: a1973d4952c5addd\n        hardware-version: 2.11\n        firmware-version: 2.1\n        flags:\n               rng\n               login-required\n               user-pin-initialized\n               restore-key-not-needed\n               clock-on-token\n               token-initialized\n// highlight-end\np11-kit-trust: p11-kit-trust.so\n    library-description: PKCS#11 Kit Trust Module\n    library-manufacturer: PKCS#11 Kit\n    library-version: 0.23\n...\nopensc: opensc-pkcs11.so\n    library-description: OpenSC smartcard framework\n    library-manufacturer: OpenSC Project\n    library-version: 0.20\n...\n"})}),"\n",(0,r.jsx)(n.h2,{id:"application-configuration",children:"Application configuration"}),"\n",(0,r.jsxs)(o.A,{groupId:"scenario",children:[(0,r.jsxs)(a.A,{value:"ossl",label:"OpenSSL",default:!0,children:[(0,r.jsx)(n.p,{children:"To use another engine, OpenSSL requires engine settings in the\nopenssl.cnf file. Some OpenSSL commands allow specifying a dedicated\nconfiguration file (-config myssl.cnf ) and some do not.  Setting the\nenvironment variable OPENSSL_CONF is a workaround, but be sometimes\nthe default openssl.cnf file contains entries that are needed by some\ncommands (e.g. openssl req)."}),(0,r.jsx)(n.p,{children:"You may add the engine entries to your default OpenSSL config file or\nadd other requirements for your OpenSSL command into the config file.\nWe suggest that you create a separate config file for interactions\nwith the HSM in order to prevent conflicts with previous settings or\ndefaults."}),(0,r.jsx)(n.p,{children:"Locate were OpenSSL and it's default configuration file is\ninstalled"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"openssl version -d\n"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:'OPENSSLDIR: "/etc/pki/tls"\n'})}),(0,r.jsx)(n.p,{children:"Create a new configuration file /etc/pki/tls/primusopenssl.cnf with\nthe engine section and other necessary controls:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",children:'openssl_conf = openssl_init\n\n[openssl_init]\nengines = engine_section\n[engine_section]\npkcs11 = pkcs11_section\n[pkcs11_section]\nengine_id = pkcs11\n# dynamic_path is not required if you have installed\n# the appropriate pkcs11 engines to your openssl directory\n# dynamic_path = /usr/local/primus/lib/libprimusP11.so\nMODULE_PATH = /usr/local/primus/lib/libprimusP11.so\n# Insert your PKCS11 password, otherwise interactively or command line option\n// highlight-next-line-info\nPIN = <PKCS#11 PIN>\n# it is not recommended to use "debug" for production use\n# INIT_ARGS = connector=http://127.0.0.1:12345 debug\ninit = 0 \n'})}),(0,r.jsx)(n.p,{children:"Include above file in /etc/pki/tls/openssl.cnf, the main OpenSSL configuration file:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",children:"# Note that you can include other files from the main configuration\n# file using the .include directive.\n.include /etc/pki/tls/primusopenssl.cnf\n"})}),(0,r.jsx)(n.p,{children:"Alternatively, you may also create an alias to use a dedicated config file:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"alias primusssl='OPENSSL_CONF=/etc/pki/tls/myprimusopenssl.cnf openssl'\n"})}),(0,r.jsxs)(n.p,{children:["The key can be referenced by URI by placing it after the -key option. ",(0,r.jsx)(n.br,{}),"\n",'E.g: Generating a CSR using the private key "myeckey" on partition "DEMO-TEST" in slot 12:']}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'openssl req -engine pkcs11 -new -key "pkcs11:token=DEMO-TEST;object=myeckey;type=private;pin-value=MYPIN" \\\n    -keyform engine -out ec.hsm.csr -sha384 -verify\n'})})]}),(0,r.jsxs)(a.A,{value:"apache",label:"Apache/httpd",children:[(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"The httpd mod_ssl module leverages OpenSSL for TLS\nconnections. OpenSSL needs to be configured."})}),(0,r.jsx)(n.p,{children:"Add at the end of the main httpd configuration file\n/etc/httpd/conf/httpd.conf the following lines:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:"<IfModule ssl_module>\n SSLRandomSeed startup builtin\n SSLRandomSeed connect builtin\n</IfModule>\n"})}),(0,r.jsx)(n.p,{children:"Adapt the mod_ssl configuration file /etc/httpd/conf.d/ssl.conf"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"SSLPassPhraseDialog builtin\n"})}),(0,r.jsx)(n.p,{children:"And reference the used Certificate and Private Key within the\nVirtualHost section using the object (=label) reference:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'SSLCertificateFile "pkcs11:token=<partition-name>;object=myrsakey;type=cert"\nSSLCertificateKeyFile "pkcs11: token=<partition-name>;object=myrsakey;type=private"\n'})})]}),(0,r.jsxs)(a.A,{value:"nginx",label:"Nginx",children:[(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"Nginx uses OpenSSL for cryptographic operations. OpenSSL needs to be\nconfigured."})}),(0,r.jsx)(n.p,{children:"Nginx currently supports only loading private keys from an HSM, and a certificate must be\nprovided separately as a regular file. Modify the nginx configuration file /etc/nginx/nginx.conf\nby activating TLS and referencing the used Certificate as regular file and Private Key within the\nserver section using the object (=label) reference:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'ssl_certificate "/path/to/cert.pem"\nssl_certificate_key "engine:pkcs11:pkcs11:token=<partition-name>;pin-value=<PKCS#11 PIN>;object=myrsakey;type=private\n'})})]})]}),"\n",(0,r.jsx)(n.h2,{id:"hms-key-reference",children:"HMS Key Reference"}),"\n",(0,r.jsx)(n.p,{children:"HSM objects are referenced in general according RFC7512 URI scheme.\nCurrently only the following URI specifier and forms are supported:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Attribute"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"token=<token label>"})}),(0,r.jsx)(n.td,{children:"Token Label (partition name)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"serial=<serial number>"})}),(0,r.jsx)(n.td,{children:"Serial Number of the partition"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"object=<object label>"})}),(0,r.jsx)(n.td,{children:"Key Label"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"id=<key id>"})}),(0,r.jsxs)(n.td,{children:["Key ID, note that pkcs11-tool writes the key id in hexadecimal notation to the HSM (e.g. ",(0,r.jsx)(n.code,{children:"%10%01"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"type=<cert|public|private>"})}),(0,r.jsx)(n.td,{children:"Key type"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"pin-value=<PKCS#11 PIN>"})}),(0,r.jsx)(n.td,{children:"to pass the PKCS11 PIN via command line"})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}}}]);
"use strict";(self.webpackChunksecurosys_docs=self.webpackChunksecurosys_docs||[]).push([[53929],{28453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>a});var t=i(96540);const s={},o=t.createContext(s);function r(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:n},e.children)}},40769:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/Primus-Crypto-Token-f8e3773438d789751e7f6f32812ceadc.png"},47282:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"Installation/Installation","title":"Configure Keyfactor EJBCA with Securosys HSM","description":"1. Verify File locations","source":"@site/primekey-ejbca/Installation/Installation.md","sourceDirName":"Installation","slug":"/Installation/","permalink":"/primekey-ejbca/Installation/","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1741162132000,"sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Configure Keyfactor EJBCA with Securosys HSM","sidebar_label":"Configure EJBCA","keywords":["cloud hsm","hsm key management","hsm cloud","hsm as a service","cloud based hsm","hsm digital signature","hsm services","hsm service","what is cloud hsm","hsm signing","hsm pki","hsm encryption","code signing hsm","hsm key","code signing service","hsm code signing","cloud code signing","cloud encryption key management","cloud hardware security module","cloudhsm vs kms","code signing certificate","key management hsm","microsoft encryption key management","hsm aws","document signing services","code signing","hsm providers","code signing as a service","aws cloudhsm documentation","hsm pricing"]},"sidebar":"tutorialSidebar","previous":{"title":"Install the API Provider","permalink":"/primekey-ejbca/Installation/Provider-setup"},"next":{"title":"Download","permalink":"/primekey-ejbca/downloads"}}');var s=i(74848),o=i(28453);const r={sidebar_position:2,title:"Configure Keyfactor EJBCA with Securosys HSM",sidebar_label:"Configure EJBCA",keywords:["cloud hsm","hsm key management","hsm cloud","hsm as a service","cloud based hsm","hsm digital signature","hsm services","hsm service","what is cloud hsm","hsm signing","hsm pki","hsm encryption","code signing hsm","hsm key","code signing service","hsm code signing","cloud code signing","cloud encryption key management","cloud hardware security module","cloudhsm vs kms","code signing certificate","key management hsm","microsoft encryption key management","hsm aws","document signing services","code signing","hsm providers","code signing as a service","aws cloudhsm documentation","hsm pricing"]},a="Installation & Configuration",c={},l=[{value:"1. Verify File locations",id:"1-verify-file-locations",level:2},{value:"2. Update Environment Settings",id:"2-update-environment-settings",level:2},{value:"3. Configure EJBCA",id:"3-configure-ejbca",level:2},{value:"EJBCA Property FILE",id:"ejbca-property-file",level:3},{value:"Optional: Database Protection Settings",id:"optional-database-protection-settings",level:3},{value:"Test with clientToolBox",id:"test-with-clienttoolbox",level:3},{value:"4. Deploy EJBCA",id:"4-deploy-ejbca",level:2},{value:"Configure new Crypto Token",id:"configure-new-crypto-token",level:3},{value:"Generate RSA Keys",id:"generate-rsa-keys",level:3},{value:"Create New CA",id:"create-new-ca",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"installation--configuration",children:"Installation & Configuration"})}),"\n",(0,s.jsx)(n.h2,{id:"1-verify-file-locations",children:"1. Verify File locations"}),"\n",(0,s.jsx)(n.p,{children:"This guide assumes the following:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["EJBCA is installed in ",(0,s.jsx)(n.code,{children:"/opt/ejbca"})]}),"\n",(0,s.jsxs)(n.li,{children:["EJBCA configurations can be found in ",(0,s.jsx)(n.code,{children:"/opt/ejbca-custom/"})]}),"\n",(0,s.jsxs)(n.li,{children:["The Primus ",(0,s.jsx)(n.a,{href:"/pkcs/overview",children:"PKCS#11 Provider"})," is installed in ",(0,s.jsx)(n.code,{children:"/usr/local/primus"})]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["If ",(0,s.jsx)(n.strong,{children:"additional locations"})," are set, update the relevant parameters in this guide as necessary."]})}),"\n",(0,s.jsx)(n.h2,{id:"2-update-environment-settings",children:"2. Update Environment Settings"}),"\n",(0,s.jsxs)(n.p,{children:["Change the profile settings for user ",(0,s.jsx)(n.code,{children:"ejbca"})," (",(0,s.jsx)(n.code,{children:".bash"}),", ",(0,s.jsx)(n.code,{children:".bash_profile"})," or ",(0,s.jsx)(n.code,{children:".profile"}),") to include the binaries and libraries to the search path:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"APPSRV_HOME=/opt/jboss\nEJBCA_HOME=/opt/ejbca\nPRIMUS_HOME=/usr/local/primus\n\nLD_LIBRARY_PATH=$PRIMUS_HOME/lib:$LD_LIBRARY_PATH\nPATH=${APPSRV_HOME}/bin:${EJBCA_HOME}/bin:$PRIMUS_HOME/bin:$PATH\nexport PATH APPSRV_HOME EJBCA_HOME PRIMUS_HOME LD_LIBRARY_PATH\n"})}),"\n",(0,s.jsx)(n.h2,{id:"3-configure-ejbca",children:"3. Configure EJBCA"}),"\n",(0,s.jsx)(n.h3,{id:"ejbca-property-file",children:"EJBCA Property FILE"}),"\n",(0,s.jsxs)(n.p,{children:["Edit the file ",(0,s.jsx)(n.code,{children:"web.properties"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"vim /opt/ejbca-custom/conf/web.properties\n"})}),"\n",(0,s.jsx)(n.p,{children:"and add the following lines at the end of the file (only for EJBCA < v7.8.1 ):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Securosys Primus HSM Section\ncryptotoken.p11.lib.132.name=Primus HSM\ncryptotoken.p11.lib.132.file=/usr/local/primus/lib/libprimusP11.so\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["Note that as of EJBCA Enterprise 7.8.1, default properties are included in the EJBCA configuration files to ease the configuration and automatically find the Primus HSM driver installed on the system. Following the integration guide, it is therefore not needed to update the ",(0,s.jsx)(n.code,{children:"conf/web.properties"})," file in (EJBCA Property File) if libprimusP11.so is located in ",(0,s.jsx)(n.code,{children:"/usr/local/primus/lib"})," or ",(0,s.jsx)(n.code,{children:"/opt/primus/lib"}),"."]})}),"\n",(0,s.jsxs)(n.p,{children:["Optionally, it is possible to define a custom PKCS#11 attribute file by appending the following lines to the file ",(0,s.jsx)(n.code,{children:"web.properties"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"cryptotoken.p11.attr.132.name=Primus HSM Attributes\ncryptotoken.p11.attr.132.file=/opt/ejbca-custom/conf/primus_hsm_p11.conf\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The following file ",(0,s.jsx)(n.code,{children:"primus_hsm_p11.conf"})," shows such an example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"name=PrimusHSM\nlibrary=/usr/local/primus/lib/libprimusP11.so\nslotListIndex=0-9\nattributes(generate,*,*) = {\n   CKA_TOKEN = true\n}\nattributes(generate,CKO_PUBLIC_KEY,*) = {\n   CKA_ENCRYPT = true\n   CKA_VERIFY = true\n   CKA_WRAP = true\n}\nattributes(generate, CKO_PRIVATE_KEY,*) = {\n   CKA_EXTRACTABLE = true\n   CKA_DECRYPT = true\n   CKA_SIGN = true\n   CKA_UNWRAP = true\n   CKA_ALWAYS_AUTHENTICATE = false\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"optional-database-protection-settings",children:"Optional: Database Protection Settings"}),"\n",(0,s.jsxs)(n.p,{children:["The configuration file ",(0,s.jsx)(n.code,{children:"databaseprotection.properties"})," (Enterprise feature) specifies the configuration used to sign the rows of various tables in order to give evidence of tampering, most commonly the AuditRecordData table (to be configured prior to installation)."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"### custom settings using Securosys Primus HSM\ndatabaseprotection.enablesign = false\ndatabaseprotection.enableverify = false\ndatabaseprotection.enablesign.AuditRecordData = true\ndatabaseprotection.enableverify.AuditRecordData = true\ndatabaseprotection.keyid = 010\ndatabaseprotection.keyid.0 = 010\ndatabaseprotection.keylabel.0 = EJBCATEST_AuditSign01\ndatabaseprotection.classname.0 = org.cesecore.keys.token.PKCS11CryptoToken\ndatabaseprotection.properties.0 = sharedLibrary=/usr/local/primus/lib/libprimusP11.so, slotLabelType=SLOT_NUMBER, slotLabel-Value=0\ndatabaseprotection.data.0 =\ndatabaseprotection.tokenpin.0 = PRIMUSDEV\ndatabaseprotection.version.0 = 2\n"})}),"\n",(0,s.jsx)(n.h3,{id:"test-with-clienttoolbox",children:"Test with clientToolBox"}),"\n",(0,s.jsx)(n.p,{children:"Before deploying EJBCA with the new provider it might be useful to test whether the connection to the HSM and key generation works.\nDeploy the EJBCA clientToolBox for this test:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"su - ejbca\ncd /opt/ejbca\nant clean clientToolBox\n"})}),"\n",(0,s.jsx)(n.p,{children:"After successful deployment, the clientToolBox can be found in /opt/ejbca/dist/clientToolBox/.\nGenerate an RSA test key:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"/opt/ejbca/dist/clientToolBox/ejbcaClientToolBox.sh PKCS11HSMKeyTool generate /usr/local/primus/lib/libprimusP11.so 4096 Securosys_EJBCA_Test_Key 0\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["The last parameter of the command indicates the slot number (",(0,s.jsx)(n.code,{children:"id"}),")."]})}),"\n",(0,s.jsx)(n.p,{children:"Example output:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Using Slot Reference Type: Slot Number.\nPKCS11 Token [SunPKCS11-libprimusP11.so-slot0] Password:\n2020-05-19 14:40:41,678 INFO [org.cesecore.keys.util.SignWithWorkingAlgorithm] Signature algorithm 'SHA1WithRSA' working for provider 'SunPKCS11-libprimusP11.so-slot0 version 1.8'.\nCreated certificate with entry Securosys_EJBCA_Test_Key.\n"})}),"\n",(0,s.jsx)(n.h2,{id:"4-deploy-ejbca",children:"4. Deploy EJBCA"}),"\n",(0,s.jsx)(n.p,{children:"Deploy EJBCA with the new settings:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"su - ejbca\ncd /opt/ejbca\nant clean deployear\n"})}),"\n",(0,s.jsx)(n.p,{children:"Wait until the jboss application server has finished the deployment:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'2020-05-19 14:52:13,600 INFO [org.jboss.as.server] (DeploymentScanner-threads - 2) WFLYSRV0016: Replaced\ndeployment "ejbca.ear" with deployment "ejbca.ear"\n'})}),"\n",(0,s.jsx)(n.h3,{id:"configure-new-crypto-token",children:"Configure new Crypto Token"}),"\n",(0,s.jsx)(n.p,{children:"Point your browser to the EJBCA Admin Web interface."}),"\n",(0,s.jsxs)(n.p,{children:["Example: ",(0,s.jsx)(n.code,{children:"https://your-ejbca-server.com:8443/ejbca/adminweb"})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:i(49247).A+"",width:"1480",height:"493"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Click on ",(0,s.jsx)(n.code,{children:"Crypto Tokens"})," in the left navigation bar and click on ",(0,s.jsx)(n.code,{children:"Create new\u2026"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Enter a name for the new Crypto Token."}),"\n",(0,s.jsxs)(n.li,{children:["Select ",(0,s.jsx)(n.code,{children:"PKCS#11"})," from the dropdown list."]}),"\n",(0,s.jsxs)(n.li,{children:["Enter the ",(0,s.jsx)(n.code,{children:"PKCS#11 Password"})," twice for the HSM partition."]}),"\n",(0,s.jsxs)(n.li,{children:["Select ",(0,s.jsx)(n.code,{children:"Auto-activation"})," to keep the partition connected when EJBCA is restarted."]}),"\n",(0,s.jsxs)(n.li,{children:["Select the ",(0,s.jsx)(n.code,{children:"Securosys Primus provider"}),". The name was set in the ",(0,s.jsx)(n.code,{children:"web.properties"})," file."]}),"\n",(0,s.jsxs)(n.li,{children:["Select ",(0,s.jsx)(n.code,{children:"Slot/Token Label"})," from the dropdown list."]}),"\n",(0,s.jsxs)(n.li,{children:["Select the ",(0,s.jsx)(n.code,{children:"partition label"})," to use."]}),"\n",(0,s.jsxs)(n.li,{children:["Select the ",(0,s.jsx)(n.code,{children:"P11 Attribute"})," file if you have created a custom file."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"generate-rsa-keys",children:"Generate RSA Keys"}),"\n",(0,s.jsxs)(n.p,{children:["Generate 3 key pairs (e.g. ",(0,s.jsx)(n.code,{children:"Test-CA_DefaultKey"}),", ",(0,s.jsx)(n.code,{children:"Test-CA_DefaultSign"}),", ",(0,s.jsx)(n.code,{children:"Test-CA_TestKey"}),") for a new CA."]}),"\n",(0,s.jsxs)(n.p,{children:["For more information on how to generate key pairs, refer to ",(0,s.jsx)(n.a,{href:"https://docs.keyfactor.com/ejbca/latest/ca-operations-guide",children:"Keyfactor/PrimeKey EJBCA Documentation"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:i(40769).A+"",width:"1396",height:"556"})}),"\n",(0,s.jsx)(n.h3,{id:"create-new-ca",children:"Create New CA"}),"\n",(0,s.jsxs)(n.p,{children:["Select ",(0,s.jsx)(n.code,{children:"Certification Authorities"}),", name the new Certificate Authority (CA) and click ",(0,s.jsx)(n.code,{children:"Create"}),". Define your CA configuration using the previously created Crypto Token and keys from the HSM. Continue setting up the CA according to your requirements and EJBCA best practices."]}),"\n",(0,s.jsxs)(n.p,{children:["For more information on EJBCA setup and best practices, refer to ",(0,s.jsx)(n.a,{href:"https://docs.keyfactor.com/ejbca/latest/ca-operations-guide",children:"Keyfactor/PrimeKey EJBCA Documentation"})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:i(97990).A+"",width:"1298",height:"544"})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},49247:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/New-Crypto-Token-21134f887a77eb77507702e44020d670.png"},97990:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/Create-CA-28fd99af92f369f2e84c9d6f497978fc.png"}}]);
"use strict";(self.webpackChunksecurosys_docs=self.webpackChunksecurosys_docs||[]).push([[30287],{28158:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>t,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"Tutorials/encrypt","title":"Docker Encryption Plugin - Encrypt an Image","description":"Encrypt an Image","source":"@site/docker_encryption/Tutorials/encrypt.md","sourceDirName":"Tutorials","slug":"/Tutorials/encrypt","permalink":"/docker_encryption/Tutorials/encrypt","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1741162132000,"sidebarPosition":1,"frontMatter":{"sidebar_position":1,"title":"Docker Encryption Plugin - Encrypt an Image","sidebar_label":"Encrypt an Image","description":"Encrypt an Image","keywords":["hsm","cloud hsm"]},"sidebar":"tutorialSidebar","previous":{"title":"Tutorial","permalink":"/docker_encryption/category/tutorial"},"next":{"title":"Decrypt an Image","permalink":"/docker_encryption/Tutorials/decrypt"}}');var o=r(74848),s=r(28453);const t={sidebar_position:1,title:"Docker Encryption Plugin - Encrypt an Image",sidebar_label:"Encrypt an Image",description:"Encrypt an Image",keywords:["hsm","cloud hsm"]},c="Encrypt an Image",a={},l=[{value:"Encrypt Docker image using local registry",id:"encrypt-docker-image-using-local-registry",level:2},{value:"Example",id:"example",level:3},{value:"Simplified Docker Image Encryption Example (optional)",id:"simplified-docker-image-encryption-example-optional",level:2},{value:"Example",id:"example-1",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"encrypt-an-image",children:"Encrypt an Image"})}),"\n",(0,o.jsx)(n.admonition,{title:"CAUTION",type:"tip",children:(0,o.jsxs)(n.p,{children:["This guide assumes the operating system used is ",(0,o.jsx)(n.strong,{children:"Linux Ubuntu 22"}),"."]})}),"\n",(0,o.jsx)(n.p,{children:"Build your image for encryption or use an already built image from any public/private registry by pulling it into your local repository. Make sure that the image is OCI-complaint."}),"\n",(0,o.jsx)(n.p,{children:"In the subsequent steps, we set up a registry on the local machine using the ORAS CLI project registry. We proceed to build and tag a Docker image from the Alpine sources on the GitHub project, and subsequently we build and push it to the local registry. Following this, we encrypt this image."}),"\n",(0,o.jsx)(n.p,{children:"For the sake of simplicity, the procedure does not differentiate between the roles of the signature issuer and verifier."}),"\n",(0,o.jsx)(n.admonition,{title:"CAUTION",type:"tip",children:(0,o.jsxs)(n.p,{children:["The following example creates a registry with ",(0,o.jsx)(n.a,{href:"https://github.com/oras-project/distribution/pkgs/container/registry",children:"oras-project/registry"})," in your local Docker environment. This registry should only be used for development purposes. When using other registries, ensure the registry is compatible with OCI Image specification v1.1.0."]})}),"\n",(0,o.jsx)(n.p,{children:"Create a local registry based on the oras-project:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"docker run -d -p 5000:5000 ghcr.io/oras-project/registry:v1.0.0-rc.4\n"})}),"\n",(0,o.jsx)(n.admonition,{title:"Note",type:"note",children:(0,o.jsx)(n.p,{children:"For Apple silicon, add the --platform linux/arm64 parameter."})}),"\n",(0,o.jsx)(n.admonition,{title:"Caution",type:"tip",children:(0,o.jsxs)(n.p,{children:["For the example remember to install and run Docker. Follow the instructions provided in ",(0,o.jsx)(n.a,{href:"/docker_encryption/Installation/prerequisites#docker-installation",children:"Prerequisites - Docker installation"}),", start docker using command: ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"sudo systemctl start docker"})}),"."]})}),"\n",(0,o.jsx)(n.h2,{id:"encrypt-docker-image-using-local-registry",children:"Encrypt Docker image using local registry"}),"\n",(0,o.jsxs)(n.p,{children:["To create your custom Docker image, start by creating a Dockerfile in an empty directory (the root directory of your project), e.g. ",(0,o.jsx)(n.code,{children:"~/Downloads/Securosy"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"vi ~/Downloads/Securosys/Dockerfile\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The Dockerfile contains the instructions on how to build your Docker image. Edit the ",(0,o.jsx)(n.em,{children:"Dockerfile"})," and add below content, then save:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"FROM alpine:latest\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Build and tag your Docker image. Tagging the image as ",(0,o.jsx)(n.code,{children:"localhost:5000/alpine:myownimage"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"docker build . -t localhost:5000/alpine:myownimage\n"})}),"\n",(0,o.jsx)(n.p,{children:"Since the image is currently only available locally, push it to the local registry using the following command:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"docker push localhost:5000/alpine:myownimage\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Use skopeo to copy and encrypt the image from the local registry to another repository, with TLS verification disabled. Adapt the values ",(0,o.jsx)(n.code,{children:"<password>"}),", ",(0,o.jsx)(n.code,{children:"<pathToConfig>"}),", ",(0,o.jsx)(n.code,{children:"<keyLabel>"}),", ",(0,o.jsx)(n.code,{children:"<myownimage>"}),"to your needs."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"[KEY_PASSWORD=password] OCICRYPT_KEYPROVIDER_CONFIG=/<pathToConfi>/ocicrypt.conf skopeo --override-os linux copy --encryption-key provider:skopeo-securosys:<keyLabel> --src-tls- verify=false --dest-tls-verify=false docker://localhost:5000/alpine:<myownimage> docker://localhost:5000/alpine:latest-encrypted-<keyLabel>\n"})}),"\n",(0,o.jsx)(n.p,{children:"Command variables:"}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:(0,o.jsx)(n.strong,{children:"Command Parameters:"})}),(0,o.jsx)(n.th,{children:(0,o.jsx)(n.strong,{children:"Description"})})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["KEY_PASSWORD=",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<password>"})})]}),(0,o.jsxs)(n.td,{children:["Replace the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<password>"})})," variable with the -key- password parameter in the configuration file. Omit if key has no password."]})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<keyLabel>"})})}),(0,o.jsx)(n.td,{children:"Replace the variable with the label of your encryption key already generated on the HSM."})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["OCICRYPT_KEYPROVIDER_CONFIG=/",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<pathToConfig>"})}),"/ocicrypt.conf"]}),(0,o.jsxs)(n.td,{children:["Replace the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<pathToConfig>"})})," with your path to the Securosys Docker Image Encryption plugin config, e.g. ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"${BINARY_PAT}"})})]})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["--src-tls-verify=false ",(0,o.jsx)("br",{})," --dest-tls-verify=false"]}),(0,o.jsx)(n.td,{children:"Remove the tls-verify options if you use a remote registry."})]})]})]}),"\n",(0,o.jsx)(n.admonition,{title:"CAUTION",type:"warning",children:(0,o.jsxs)(n.p,{children:["In our example, TLS is disabled because we are working with a local. If you use a remote registry, TLS will be used, and the tls-verify option --",(0,o.jsx)(n.strong,{children:"dest-tls-verify=false"})," must be removed."]})}),"\n",(0,o.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,o.jsx)(n.p,{children:"Example commands and sample output of above sequence."}),"\n",(0,o.jsx)(n.p,{children:"Build and tag:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"docker build . -t localhost:5000/alpine:myownimage \n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"[+] Building 0.0s (5/5) FINISHED                                docker:desktop-linux\n=> [internal] load build definition from Dockerfile             0.0s  \n=> => transferring dockerfile: 57B                              0.0s\n=> [internal] load .dockerignore                                0.0s\n=> => transferring context: 2B                                  0.0s\n=> [internal] load metadata for docker.io/library/alpine:latest 0.0s\n=> CACHED [1/1] FROM docker.io/library/alpine:latest            0.0s\n=> exporting to image                                           0.0s\n=> => exporting layers                                          0.0s\n=> => writing image sha256:38f483c2ec62748751a5096708f9633c581f93454e202da84e9d7951a63a4a22     0.0s\n=> => naming to localhost:5000/alpine:myownimage                0.0s\nView build details: docker-desktop://dashboard/build/desktop-linux/desktop- linux/n2jop7yjpp8ipm4e8zqcb51yr\n"})}),"\n",(0,o.jsx)(n.p,{children:"Push image to local registry:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"docker push localhost:5000/alpine:myownimage \n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"The push refers to repository [localhost:5000/alpine]\n3ce819cc4970: Pushed\nmyownimage: digest: \nsha256:0dfd193b4c325c6158aa178c3b46a34c060e23a0f6f3f87480b9b9131b707f30 \nsize: 527 \n"})}),"\n",(0,o.jsx)(n.p,{children:"Encrypt image:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"OCICRYPT_KEYPROVIDER_CONFIG=/home/Securosys/Securosys/skopeo/ocicrypt.conf skopeo -- override-os mac copy --encryption-key provider:skopeo-securosys:SecurosysEncKey21 --src- tls-verify=false --dest-tls-verify=false docker://localhost:5000/alpine:myownimage docker://localhost:5000/alpine:latest-encrypted-SecurosysEncKey01\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Getting image source signatures \nCopying blob c30352492317 done   |  \nCopying config 1021c26281 done   |  \nWriting manifest to image destination \n"})}),"\n",(0,o.jsx)(n.h2,{id:"simplified-docker-image-encryption-example-optional",children:"Simplified Docker Image Encryption Example (optional)"}),"\n",(0,o.jsx)(n.p,{children:"Skopeo is part of the tools commonly used in container orchestration and deployment workflows. The primary purpose of skopeo is to work with container images across different container image registries. It is a command-line utility used in the container ecosystem to perform various operations related to container image copying, moving, inspection, and it allows transferring images without running a Docker daemon."}),"\n",(0,o.jsx)(n.admonition,{title:"NOTE",type:"note",children:(0,o.jsxs)(n.p,{children:["For a quick verification of the encryption functionality, you can bypass above steps and use Skopeo to directly copy the image from docker.io using the following command: ",(0,o.jsx)(n.code,{children:"skopeo copy docker:imageExample"})]})}),"\n",(0,o.jsxs)(n.p,{children:["In accordance with ",(0,o.jsx)(n.a,{href:"https://github.com/containers/skopeo",children:"Skopeo"}),", you have the option to utilize skopeo directly for copying and encrypting Docker images, eliminating the necessity for a registry. Although this approach may not precisely mirror real-world scenarios, it facilitates a prompt verification of the encrypt/decrypt functionality."]}),"\n",(0,o.jsxs)(n.p,{children:["Navigate to the skopeo working directory ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"${BINARY_PATH}"})}),", as defined in chapter ",(0,o.jsx)(n.a,{href:"/docker_encryption/Installation/configuration#install-the-securosys-docker-image-encryption-plugin-binary",children:"Installation - Install the Securosys Docker Image Encryption Plugin binary"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"We are using image of the Alpine project from docker.io as a sample and copy it to the working directory:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"skopeo copy docker://docker.io/amd64/alpine:latest oci:alpine\n"})}),"\n",(0,o.jsx)(n.admonition,{title:"NOTE",type:"note",children:(0,o.jsx)(n.p,{children:"For Apple silicon use alpine image arm64v8."})}),"\n",(0,o.jsx)(n.p,{children:"Next, encrypt the image as shown below:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"[KEY_PASSWORD=password] OCICRYPT_KEYPROVIDER_CONFIG=pathToConfig/ocicrypt.conf skopeo --override-os linux copy --encryption-key provider:skopeo-securosys:keyLabel oci:alpine oci:apline-encrypted \n"})}),"\n",(0,o.jsx)(n.p,{children:"Command variables:"}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:(0,o.jsx)(n.strong,{children:"Command Parameters:"})}),(0,o.jsx)(n.th,{children:(0,o.jsx)(n.strong,{children:"Description"})})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["KEY_PASSWORD=",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<password>"})})]}),(0,o.jsxs)(n.td,{children:["Replace the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<password>"})})," variable with the -key- password parameter in the configuration file. Omit if key has no password."]})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<keyLabel>"})})}),(0,o.jsx)(n.td,{children:"Replace the variable with the label of your encryption key already generated on the HSM."})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["OCICRYPT_KEYPROVIDER_CONFIG=/",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<pathToConfig>"})}),"/ocicrypt.conf"]}),(0,o.jsxs)(n.td,{children:["Replace the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<pathToConfig>"})})," with your path to the Securosys Docker Image Encryption plugin config, e.g. ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"<BINARY_PATH>"})})]})]})]})]}),"\n",(0,o.jsx)(n.h3,{id:"example-1",children:"Example"}),"\n",(0,o.jsxs)(n.p,{children:["Example command and its output. Encryption of image ",(0,o.jsx)(n.code,{children:"alpine"})," and storing it as ",(0,o.jsx)(n.code,{children:"alpine-encrypted"}),". For a key without password:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"OCICRYPT_KEYPROVIDER_CONFIG=/home/Securosys/Securosys/skopeo/ocicrypt.conf skopeo -- override-os linux copy --encryption-key provider:skopeo-securosys:SecurosysEncKey01 oci:alpine oci:alpine-encrypted\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Getting image source signatures Copying blob 05e7bc50f07f done Copying config 5c41fd95ee done Writing manifest to image destination \n"})}),"\n",(0,o.jsx)(n.p,{children:"The encrypted image will be created in directory `alpine-encrypted`` under the directory where you run the command."})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>c});var i=r(96540);const o={},s=i.createContext(o);function t(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);
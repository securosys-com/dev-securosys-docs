"use strict";(self.webpackChunksecurosys_docs=self.webpackChunksecurosys_docs||[]).push([[75063],{20961:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"osslv3/Installation/configuration","title":"Configuring PKCS#11 for OpenSSL v3 and HSM","description":"Discover OpenSSL\'s PKCS11 provider, CLI commands, installation tips, and troubleshooting. Integrate seamlessly with HSM for enhanced security.","source":"@site/openssl/osslv3/Installation/configuration.md","sourceDirName":"osslv3/Installation","slug":"/osslv3/Installation/configuration","permalink":"/openssl/osslv3/Installation/configuration","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"OpenSSL","permalink":"/openssl/tags/open-ssl"},{"inline":true,"label":"PKCS#11","permalink":"/openssl/tags/pkcs-11"}],"version":"current","lastUpdatedAt":1741162132000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Configuring PKCS#11 for OpenSSL v3 and HSM","sidebar_label":"Configuration","description":"Discover OpenSSL\'s PKCS11 provider, CLI commands, installation tips, and troubleshooting. Integrate seamlessly with HSM for enhanced security.","keywords":["OpenSSL PKCS11 provider","OpenSSL PKCS11 API","OpenSSL command line utility (CLI)","OpenSSL CLI commands","OpenSSL installation guide","OpenSSL installation troubleshooting","OpenSSL troubleshooting tips","OpenSSL certificate management","OpenSSL certificate creation","OpenSSL certificate renewal","OpenSSL configuration file","OpenSSL configuration options","OpenSSL configuration guide","OpenSSL encryption algorithms","OpenSSL decryption methods","OpenSSL digital signatures","OpenSSL SSL/TLS protocols","OpenSSL SSL/TLS configuration","OpenSSL heartbleed vulnerability","OpenSSL security updates"],"tags":["OpenSSL","PKCS#11"]},"sidebar":"openssl","previous":{"title":"Installation","permalink":"/openssl/osslv3/Installation/"},"next":{"title":"Tutorial","permalink":"/openssl/category/tutorial"}}');var o=i(74848),s=i(28453);const r={sidebar_position:3,title:"Configuring PKCS#11 for OpenSSL v3 and HSM",sidebar_label:"Configuration",description:"Discover OpenSSL's PKCS11 provider, CLI commands, installation tips, and troubleshooting. Integrate seamlessly with HSM for enhanced security.",keywords:["OpenSSL PKCS11 provider","OpenSSL PKCS11 API","OpenSSL command line utility (CLI)","OpenSSL CLI commands","OpenSSL installation guide","OpenSSL installation troubleshooting","OpenSSL troubleshooting tips","OpenSSL certificate management","OpenSSL certificate creation","OpenSSL certificate renewal","OpenSSL configuration file","OpenSSL configuration options","OpenSSL configuration guide","OpenSSL encryption algorithms","OpenSSL decryption methods","OpenSSL digital signatures","OpenSSL SSL/TLS protocols","OpenSSL SSL/TLS configuration","OpenSSL heartbleed vulnerability","OpenSSL security updates"],tags:["OpenSSL","PKCS#11"]},a="Configuring PKCS#11 for OpenSSL v3",l={},c=[{value:"pkcs11-provider options",id:"pkcs11-provider-options",level:3},{value:"More resources",id:"more-resources",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"configuring-pkcs11-for-openssl-v3",children:"Configuring PKCS#11 for OpenSSL v3"})}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.strong,{children:"OpenSSL PKCS#11 Provider API"})," tries to be compatible with a wide range of tokens and offers some parameters to adapt to the different Cryptoki implementations."]}),"\n",(0,o.jsxs)(n.p,{children:["The full range of configuration options can be found in the provider's ",(0,o.jsx)(n.a,{href:"https://github.com/latchset/pkcs11-provider/blob/main/HOWTO.md",children:"HOWTO.md"})," and the ",(0,o.jsx)(n.a,{href:"https://github.com/latchset/pkcs11-provider/blob/main/docs/provider-pkcs11.7.md",children:"GitHub manual"}),". In the following the options that are relevant for the Securosys HSM are presented."]}),"\n",(0,o.jsxs)(n.p,{children:["For a system wide configuration of the PKCS#11 API Provider, edit the ",(0,o.jsx)(n.code,{children:"openssl.cnf"}),"-file in the ",(0,o.jsx)(n.code,{children:"OPENSSLDIR"}),". You can find the ",(0,o.jsx)(n.code,{children:"OPENSSLDIR"})," location using ",(0,o.jsx)(n.code,{children:"openssl version -a"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["To restrict the HSM usage to specific applications, you can create a copy of the configuration file in a chosen location and set the ",(0,o.jsx)(n.code,{children:"OPENSSL_CONF"})," environment variable to point to it. This ensures OpenSSL uses the new configuration. For additional ways to customize OpenSSL configurations, please refer to the ",(0,o.jsx)(n.a,{href:"https://docs.openssl.org/master/",children:"OpenSSL documentation"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"The OpenSSL configuration is a ini-like configuration file. The\nexample below is a minimal configuration file."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ini",children:"HOME = .\nopenssl_conf = openssl_init\nconfig_diagnostics = 1\n\n[openssl_init]\nproviders = provider_sect\n// highlight-next-line-info\nrandom = random_sect\n\n// highlight-info-start\n[random_sect]\nrandom = PKCS11-RAND\n// highlight-info-end\n\n[provider_sect]\ndefault = default_sect\n// highlight-next-line-warning\nbase = base_sect\n// highlight-next-line-tip\npkcs11 = pkcs11_sect\n\n// highlight-warning-start\n[base_sect]\nactivate = 1\n// highlight-warning-end\n\n// highlight-warning-start\n[default_sect]\nactivate = 1\n// highlight-warning-end\n\n// highlight-tip-start\n[pkcs11_sect]\nmodule = /usr/local/lib/ossl-modules/pkcs11.so\npkcs11-module-path = /usr/local/primus/lib/libprimusP11.so\n#pkcs11-module-token-pin = file://$ENV::OSSL_PKCS11_PIN_FILE\npkcs11-module-load-behavior = early\npkcs11-module-quirks = no-deinit no-operation-state\nactivate = 1\n// highlight-tip-end\n"})}),"\n",(0,o.jsxs)(n.admonition,{type:"info",children:[(0,o.jsx)(n.mdxAdmonitionTitle,{children:(0,o.jsx)(n.code,{children:"PKCS11-RAND"})}),(0,o.jsxs)(n.p,{children:["Enabling the ",(0,o.jsx)(n.code,{children:"PKCS11-RAND"})," to use the HSM as source for randomness is\n",(0,o.jsx)(n.strong,{children:"optional"}),". It is disabled in the configuration obtained by\nfollowing the ",(0,o.jsx)(n.a,{href:"/openssl/osslv3/quickstart",children:"quick-start guide"}),"."]})]}),"\n",(0,o.jsx)(n.admonition,{title:"Important",type:"warning",children:(0,o.jsx)(n.p,{children:"The base-provider and default-provider need to be enabled\nexplicitly. Otherwise the encoding function as well as the majority of\nalgorithms implemented by OpenSSL will not be accessible."})}),"\n",(0,o.jsx)(n.h3,{id:"pkcs11-provider-options",children:"pkcs11-provider options"}),"\n",(0,o.jsxs)(n.p,{children:["The actual configuration of the provider is placed in ",(0,o.jsx)(n.code,{children:"[pkcs11_sect]"}),".\nIt needs to be listed in the ",(0,o.jsx)(n.code,{children:"[provider_sect]"}),"."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"module"})," and the ",(0,o.jsx)(n.code,{children:"pkcs11-module-path"})," options are mandatory. They\nhave to point to the installed ",(0,o.jsx)(n.em,{children:"pkcs11.so"})," file and the\n",(0,o.jsx)(n.em,{children:"libprimusP11.so"})," file you installed when setting up the HSM's PKCS#11\ninterface."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"pkcs11-module-token-pin"})," can be used to point to a file\ncontaining the PKCS#11 PIN. When multiple tokens are accessible, the\nPIN for the specific token should be provided in the pkcs11-uri."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"pkcs11-module-load-behavior"})," can be used to change the behavior\non the application start. By setting it to ",(0,o.jsx)(n.code,{children:"early"}),", the\npkcs11-provider gets a list of supported operations when it is\nloaded. Without this option, the connection to the HSM is only\nestablished when requested. The ",(0,o.jsx)(n.code,{children:"early"})," load behavior is needed when\nworking with the OpenSSL on the command line."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"pkcs11-module-quirks"})," are used to inform the pkcs11-provider\nabout certain properties of the token that might be considered\nunusual."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["The option ",(0,o.jsx)(n.code,{children:"no-deinit"})," prevents the de-initialization of the Primus\npkcs11-provider. As part of the exit routine the OpenSSL command\nline interface tries to do a clean up. However, the deallocation on\nexit is done in reverse order of allocation, which means that the\nC++ objects in the Primus pkcs11 provider are already\nfreed. Applications that call ",(0,o.jsx)(n.code,{children:"OPENSSL_cleanup"})," before the exiting\ndo not need that flag. Applications that re-load the OpenSSL library\nshould not use this flag to avoid memory leaks."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["The HSM does not support getting and setting the operation\nstate. Thus, the context cannot be duplicated during digest and sign\noperations. By setting ",(0,o.jsx)(n.code,{children:"no-operation-state"}),", the duplication is not\nperformed."]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"more-resources",children:"More resources"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/openssl/osslv3/Tutorial/openssl_cli",children:"Generate a key with OpenSSL"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"../Tutorial/troubleshooting",children:"Troubleshooting"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/latchset/pkcs11-provider/blob/main/HOWTO.md",children:"HOWTO.md"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/latchset/pkcs11-provider/blob/main/docs/provider-pkcs11.7.md",children:"GitHub manual"})}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://docs.openssl.org/master/",children:"OpenSSL documentation"}),"."]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>a});var t=i(96540);const o={},s=t.createContext(o);function r(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);
"use strict";(self.webpackChunksecurosys_docs=self.webpackChunksecurosys_docs||[]).push([[52046],{28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var s=t(96540);const o={},i=s.createContext(o);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),s.createElement(i.Provider,{value:n},e.children)}},46937:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"Concepts/autounseal","title":"Auto-Unseal - HashiCorp Vault Community","description":"Auto-Unseal - HashiCorp Vault Community","source":"@site/hc_vault/Concepts/autounseal.md","sourceDirName":"Concepts","slug":"/Concepts/autounseal","permalink":"/hc_vault/Concepts/autounseal","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1741162132000,"sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Auto-Unseal - HashiCorp Vault Community","sidebar_label":"Auto-Unseal","description":"Auto-Unseal - HashiCorp Vault Community","keywords":["hsm","cloud hsm"]},"sidebar":"tutorialSidebar","previous":{"title":"Unsealing with Authorization App","permalink":"/hc_vault/Concepts/approverapp"},"next":{"title":"Secret engine","permalink":"/hc_vault/Concepts/sse"}}');var o=t(74848),i=t(28453);const r={sidebar_position:2,title:"Auto-Unseal - HashiCorp Vault Community",sidebar_label:"Auto-Unseal",description:"Auto-Unseal - HashiCorp Vault Community",keywords:["hsm","cloud hsm"]},a="Auto-Unseal with Hardware Security Module (HSM)",l={},c=[{value:"Using Shamir Secrets",id:"using-shamir-secrets",level:5}];function u(e){const n={admonition:"admonition",code:"code",h1:"h1",h5:"h5",header:"header",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"auto-unseal-with-hardware-security-module-hsm",children:"Auto-Unseal with Hardware Security Module (HSM)"})}),"\n",(0,o.jsxs)(n.p,{children:["Auto-unseal can be achieved via REST (TSB) interface, connected to Securosys Primus HSM or CloudHSM. In the configuration file ",(0,o.jsx)(n.strong,{children:"config.hcl"}),", add the additional seal configuration section ",(0,o.jsx)(n.strong,{children:'seal "securosys-hsm"'}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:'  seal "securosys-hsm" {\n    //Define the unseal key stored on the HSM. If the key does not exist, a new key is created with the attributes defined in this file.\n    key_label = "replace-me_key_label"\n    //Key password\n    key_password = "password"\n    //RestApi url for calling requests to Securosys HSM via REST(TSB)\n    tsb_api_endpoint = "replace-me_TSB_Endpoint" //https://rest-api.cloudshsm.com, https://sbx-rest-api.cloudshsm.com, https://primusdev.cloudshsm.com\n    //Define the authorization type (TOKEN, CERT, NONE)\n    auth = "TOKEN"\n    //auth = TOKEN: define the JWT token to authorize at TSB\n    bearer_token = "replace-me_BearerToken"\n    //auth = CERT: mTLS, define the certificate to authorize at TSB\n    //cert_path = "replace-me_with_cert_path"\n    //Approval checking frequency in seconds\n    check_every = 5\n    //Wait for user approvals in seconds\n    approval_timeout = 30\n\n    //The following section defines the simple ska policy (SKA, ruleUse), applied only in case a new unseal key is created on the HSM.\n\n    //FORMAT OBJECT:\n    //name - RSA public key (pem)\n    policy = <<EOF\n    {\n      "replace-me_nameOfApprover":"replace-me_ApproverPublicKey"\n    }\n    EOF\n  }\n\n'})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"policy"}),":"]}),"\n",(0,o.jsxs)(n.p,{children:["Define a simple Smart Key Attribute (SKA) ",(0,o.jsx)(n.strong,{children:"ruleUse"})," policy, used for initializing the Vault when creating a new unseal key on the Hardware Security Module (HSM)."]}),"\n",(0,o.jsx)(n.p,{children:"To use a full (complex) SKA policy, the key and policy must be created outside of Vault (e.g. via REST interface, Securosys Secrets Engine, ...). Vault will gather an existing unseal key policy from the HSM. If a policy exists on the unseal key, Vault will wait for all necessary approvals before unsealing (HSM enforced)."}),"\n",(0,o.jsxs)(n.admonition,{type:"note",children:[(0,o.jsx)(n.mdxAdmonitionTitle,{}),(0,o.jsxs)(n.p,{children:["The configuration section ",(0,o.jsx)(n.strong,{children:"seal securosys-hsm"})," is only validated on startup of the ",(0,o.jsx)(n.strong,{children:"Hashicorp Vault Server"}),"."]})]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Important"})," After the ",(0,o.jsx)(n.code,{children:"operator init"})," command Vault will print the Shamir ",(0,o.jsx)(n.strong,{children:"Unseal Keys"})," and the ",(0,o.jsx)(n.strong,{children:"Initial Root Token"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Unseal Key 1: <unseal_key>\n...\nInitial Root Token: <root_key>\n\n"})}),"\n",(0,o.jsx)(n.p,{children:"Note down these values, and store them in a safe place for disaster recovery."}),"\n",(0,o.jsx)(n.h5,{id:"using-shamir-secrets",children:"Using Shamir Secrets"}),"\n",(0,o.jsxs)(n.admonition,{type:"note",children:[(0,o.jsx)(n.mdxAdmonitionTitle,{}),(0,o.jsx)(n.p,{children:'This works only with normal Shamir secrets. Using seal "securosys-hsm" the Vault is automatically unsealed on startup.'})]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Unseal"})," the server with the command ",(0,o.jsx)(n.code,{children:"vault operator unseal <unseal_key>"})," and write system env with root token using this command ",(0,o.jsx)(n.code,{children:"vault login <root-token>"})]}),"\n",(0,o.jsxs)(n.p,{children:["Alternatively the ",(0,o.jsx)(n.strong,{children:"Web UI"})," can be used."]})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(u,{...e})}):u(e)}}}]);
"use strict";(self.webpackChunksecurosys_docs=self.webpackChunksecurosys_docs||[]).push([[96994],{28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>o});var r=n(96540);const i={},a=r.createContext(i);function s(e){const t=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(a.Provider,{value:t},e.children)}},42622:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"Installation/FortiGate_Configuration","title":"Configuring FortiGate with Security HSM","description":"Configuring Fortinet FortiGate Next Gen Firewall (NGFW) with Securosys Hardware Security Modules (HSMs).","source":"@site/fortigate/Installation/FortiGate_Configuration.md","sourceDirName":"Installation","slug":"/Installation/FortiGate_Configuration","permalink":"/fortigate/Installation/FortiGate_Configuration","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1741162132000,"sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Configuring FortiGate with Security HSM","sidebar_label":"3. FortiGate Configuration","description":"Configuring Fortinet FortiGate Next Gen Firewall (NGFW) with Securosys Hardware Security Modules (HSMs).","keywords":["fortinet","fortigate","firewall","hsm clusters","integration","primus hsm","securosys"]},"sidebar":"tutorialSidebar","previous":{"title":"2. API Provider","permalink":"/fortigate/Installation/ProviderPreparation"},"next":{"title":"Download","permalink":"/fortigate/downloads"}}');var i=n(74848),a=n(28453),s=n(65537),o=n(79329);const l={sidebar_position:2,title:"Configuring FortiGate with Security HSM",sidebar_label:"3. FortiGate Configuration",description:"Configuring Fortinet FortiGate Next Gen Firewall (NGFW) with Securosys Hardware Security Modules (HSMs).",keywords:["fortinet","fortigate","firewall","hsm clusters","integration","primus hsm","securosys"]},c="Configuring FortiGate",u={},d=[{value:"1. HSM Registration",id:"1-hsm-registration",level:2},{value:"2. Upload the HSM Configuration File",id:"2-upload-the-hsm-configuration-file",level:2},{value:"3. Prepare and Configure HSM Secrets",id:"3-prepare-and-configure-hsm-secrets",level:2}];function p(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"configuring-fortigate",children:"Configuring FortiGate"})}),"\n",(0,i.jsxs)(t.p,{children:["The HSM integration is done via the ForteGate ",(0,i.jsx)(t.code,{children:"nethsm"})," module (Command Line Interface)."]}),"\n",(0,i.jsx)(t.h2,{id:"1-hsm-registration",children:"1. HSM Registration"}),"\n",(0,i.jsx)(t.p,{children:"Enable HSM functionality with following command:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"config system nethsm\nset status enable\n"})}),"\n",(0,i.jsx)(t.h2,{id:"2-upload-the-hsm-configuration-file",children:"2. Upload the HSM Configuration File"}),"\n",(0,i.jsxs)(s.A,{groupId:"forti-hsmconfig",children:[(0,i.jsxs)(o.A,{value:"forti-cli-uploadconfigfile",label:"Upload the HSM Configuration File",default:!0,children:[(0,i.jsxs)(t.p,{children:["It is recommended to upload the previously tested configuration file (primus.cfg) in raw mode via a tftp server ",(0,i.jsx)("br",{}),"\n(e.g. ",(0,i.jsx)(t.a,{href:"http://tftpd32.jounin.net",children:"http://tftpd32.jounin.net"}),"):"]}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"execute nethsm upload-primus-cfg-raw <configFileName> <tftp-server-ip> e.g.\n"})}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-text",children:"execute nethsm upload-primus-cfg-raw primusorigext.cfg 192.168.159.1\nThis will apply the new primus.cfg without applying recommended settings. Do you want to continue? (y/n)y\n\n\nprimus.cfg has been updated.\n"})})]}),(0,i.jsxs)(o.A,{value:"forti-cli-loadconfig",label:"Alternatively Transfer Configuration via CLI",default:!0,children:[(0,i.jsx)(t.admonition,{title:"quotes",type:"warning",children:(0,i.jsx)(t.p,{children:"Any quotes in the configuration file have to be escaped by a backslash!"})}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:'config system nethsm\nset status enable\nset primus-cfg \\"#-----------------------------\n# Primus PKCS#11 configuration\n#-----------------------------\nversion = \\"1.0\\";\n\n/* This example configuration template contains 3 slots:                   */\n/* hsm0: standalone hsm with one partition (slot id 0)                     */ \n/* hsm1,hsm2: redundant hsm cluster with each two partitions (slot id 1+2) */\n/*            e.g. for CloudsHSM service                                   */\n/* Comment/Uncomment the hsm or slot sections to adapt to your setup       */\n/* See PKCS#11 Provider User Guide for details                             */\n# FORTIGATE Integration Test\n\n/*--- GLOBAL CONFIGURATION SECTION ----------------------------------------*/\nprimus:\n{\n  wait_delay = 250; /* in ms*/\n\n\u2026"\n'})})]})]}),"\n",(0,i.jsx)(t.h2,{id:"3-prepare-and-configure-hsm-secrets",children:"3. Prepare and Configure HSM Secrets"}),"\n",(0,i.jsx)(t.p,{children:"The connection permenent secrets(s) and pkcs11-pin(s) have to be configured via CLI (or GUI)."}),"\n",(0,i.jsxs)(t.p,{children:["The base-64 encoded ",(0,i.jsx)(t.em,{children:".secrets.cfg"})," file can be generated without local traces using the ppin tool console output (highlighted part), on the ",(0,i.jsx)(t.a,{href:"/fortigate/Installation/ProviderPreparation",children:"client machine"}),":"]}),"\n",(0,i.jsx)(t.admonition,{type:"warning",children:(0,i.jsx)(t.p,{children:"The maximum secrets length supported by FortiGate is 3k bytes."})}),"\n",(0,i.jsx)(s.A,{groupId:"forti-version",children:(0,i.jsxs)(o.A,{value:"cli",label:"Secrets-File fetching and encoding",default:!0,children:[(0,i.jsx)(t.p,{children:"Note: for interactive input ommit the optional parameters."}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"ppin --fortinet --user <username> [<setupPassword> <PKCS11Password>] [--proxyuser <proxyUserName> [--proxypassword <proxyPassword>]]   \n"})}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-text",children:"# Fortinet secret to be loaded:\n// highlight-tip-start\ndmVyc2lvbiA9ICIxLjAiOwpwcmltdXMgOiAKewogIHVzZXJzIDogCiAgewogICAgdXNlcjAgOiAKICAgIHsKICAgICAgbmFtZSA9ICJQUklNVVNERVYzNjgiOwogICAgICBdpY3MgPSAiMzcwYzJj\n... \nGUwY2Y4ZjNhNTkwMzE2ZjE4MGI4YWZlNDdiMzY1Nzg1ZWQ3NyI7CiAgICB9OwogIH07Cn07Cg==\n// highlight-tip-end\n"})})]})}),"\n",(0,i.jsxs)(t.p,{children:["The parameter ",(0,i.jsx)(t.strong,{children:"pkcs11-pin"})," corresponds to the HSM PKCS#11 password and should be available from the HSM administrator (or configured ",(0,i.jsx)(t.a,{href:"/fortigate/Installation/prerequisites#set-pkcs11-password",children:"previously"}),")."]}),"\n",(0,i.jsx)(t.p,{children:"To configure the prepared connection secrets and pkcs11-pin(s) of the HSM partition(s) via CLI, use the following command sequence:"}),"\n",(0,i.jsxs)(s.A,{groupId:"forti-secrets",children:[(0,i.jsx)(o.A,{value:"forti-cli-syntax",label:"Syntax",default:!0,children:(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-text",children:'config system nethsm\n  set status enable\n  set primus-cfg "<content of primus.cfg escaped, if not already loaded via tftp>"\n  set secret-content <base-64 encoded .secrets.cfg file as output of ppin --fortinet>\n  config partitions\n      edit "<partition name 1>"\n          set slot-id <pkcs#11 slot index>\n          set pkcs11-pin <PKCS#11 PIN of this partition>\n      next\n      edit "<partition name 2>"\n          set slot-id <pkcs#11 slot index>\n          set pkcs11-pin <PKCS#11 PIN of this partition>\n      next\n  end\nend\n'})})}),(0,i.jsxs)(o.A,{value:"forti-cli-example",label:"Example configuration",default:!0,children:[(0,i.jsx)(t.p,{children:"Configuration file primus.cfg already uploaded via tftp."}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-text",children:'config system nethsm\n    set status enable\n    set secret-content dmVyc2lvbiA9ICIxLjAiOwpwcmltdX...9OwogIH07Cn07Cg==\n    config partitions\n      edit "PRIMUSDEV368"\n          set slot-id 0\n          set pkcs11-pin PRIMUSDEV\n      next\n      edit "ALDUROZEP"\n          set slot-id 1\n          set pkcs11-pin dbZMEmqpMNU7PRIMUSDEV\n      next\n    end\nend\n'})})]})]}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(t.p,{children:"FortiGate stores and outputs above values in an encrypted format (see FortiGate documentation for details). If previously configured, these values can also be entered in the FortiGate encrypted format (using ENC in front of the value):"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-text",children:'config system nethsm\n    set status enable\n    set secret-content ENC kFR3tNLNuU5y4Lr08RMxx//gGBQznk0vgBiILs/L....\n    config partitions\n        edit "PRIMUSDEV368"\n            set slot-id 0\n            set pkcs11-pin ENC Y6f4fDwBaF2GUcT21R8Q9KTbi9Kw8N...\n        next\n        edit "ALDUROZEP"\n            set slot-id 1\n            set pkcs11-pin ENC WQw9aQ2qKTyDeWtDgsvujjqBWCoV/E...\n        next\n    end\nend\n'})}),"\n",(0,i.jsxs)(t.p,{children:["For detailed FortiGate command description, certificate generation and usage refer to the ",(0,i.jsx)(t.a,{href:"https://dlarea.securosys.com/partner/fortinet/FortiOS-7.2.8-HSM%20Integration%20with%20FortiGate.pdf",children:"FortiGate documentation"}),"."]})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}},65537:(e,t,n)=>{n.d(t,{A:()=>y});var r=n(96540),i=n(34164),a=n(65627),s=n(56347),o=n(50372),l=n(30604),c=n(11861),u=n(78749);function d(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function p(e){const{values:t,children:n}=e;return(0,r.useMemo)((()=>{const e=t??function(e){return d(e).map((e=>{let{props:{value:t,label:n,attributes:r,default:i}}=e;return{value:t,label:n,attributes:r,default:i}}))}(n);return function(e){const t=(0,c.XI)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function h(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function f(e){let{queryString:t=!1,groupId:n}=e;const i=(0,s.W6)(),a=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,l.aZ)(a),(0,r.useCallback)((e=>{if(!a)return;const t=new URLSearchParams(i.location.search);t.set(a,e),i.replace({...i.location,search:t.toString()})}),[a,i])]}function g(e){const{defaultValue:t,queryString:n=!1,groupId:i}=e,a=p(e),[s,l]=(0,r.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!h({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const r=n.find((e=>e.default))??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:a}))),[c,d]=f({queryString:n,groupId:i}),[g,m]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[i,a]=(0,u.Dv)(n);return[i,(0,r.useCallback)((e=>{n&&a.set(e)}),[n,a])]}({groupId:i}),x=(()=>{const e=c??g;return h({value:e,tabValues:a})?e:null})();(0,o.A)((()=>{x&&l(x)}),[x]);return{selectedValue:s,selectValue:(0,r.useCallback)((e=>{if(!h({value:e,tabValues:a}))throw new Error(`Can't select invalid tab value=${e}`);l(e),d(e),m(e)}),[d,m,a]),tabValues:a}}var m=n(9136);const x={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=n(74848);function v(e){let{className:t,block:n,selectedValue:r,selectValue:s,tabValues:o}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,a.a_)(),u=e=>{const t=e.currentTarget,n=l.indexOf(t),i=o[n].value;i!==r&&(c(t),s(i))},d=e=>{let t=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const n=l.indexOf(e.currentTarget)+1;t=l[n]??l[0];break}case"ArrowLeft":{const n=l.indexOf(e.currentTarget)-1;t=l[n]??l[l.length-1];break}}t?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":n},t),children:o.map((e=>{let{value:t,label:n,attributes:a}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:r===t?0:-1,"aria-selected":r===t,ref:e=>{l.push(e)},onKeyDown:d,onClick:u,...a,className:(0,i.A)("tabs__item",x.tabItem,a?.className,{"tabs__item--active":r===t}),children:n??t},t)}))})}function j(e){let{lazy:t,children:n,selectedValue:a}=e;const s=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=s.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:s.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==a})))})}function w(e){const t=g(e);return(0,b.jsxs)("div",{className:(0,i.A)("tabs-container",x.tabList),children:[(0,b.jsx)(v,{...t,...e}),(0,b.jsx)(j,{...t,...e})]})}function y(e){const t=(0,m.A)();return(0,b.jsx)(w,{...e,children:d(e.children)},String(t))}},79329:(e,t,n)=>{n.d(t,{A:()=>s});n(96540);var r=n(34164);const i={tabItem:"tabItem_Ymn6"};var a=n(74848);function s(e){let{children:t,hidden:n,className:s}=e;return(0,a.jsx)("div",{role:"tabpanel",className:(0,r.A)(i.tabItem,s),hidden:n,children:t})}}}]);
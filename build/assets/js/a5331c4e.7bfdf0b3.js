"use strict";(self.webpackChunksecurosys_docs=self.webpackChunksecurosys_docs||[]).push([[67474],{28453:(e,s,n)=>{n.d(s,{R:()=>a,x:()=>l});var t=n(96540);const i={},r=t.createContext(i);function a(e){const s=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(r.Provider,{value:s},e.children)}},42524:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"Tutorials/Shared-access","title":"Configuring MS SQL AE for Shared User Access with a Global CMK","description":"Creating a Shared Access Column Master Key for Microsoft SQL Always Encrypted with Securosys Hardware Security Modules (HSMs)","source":"@site/ms-sql-ae/Tutorials/Shared-access.md","sourceDirName":"Tutorials","slug":"/Tutorials/Shared-access","permalink":"/ms-sql-ae/Tutorials/Shared-access","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1741162132000,"sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Configuring MS SQL AE for Shared User Access with a Global CMK","sidebar_label":"Shared User Access SQL","description":"Creating a Shared Access Column Master Key for Microsoft SQL Always Encrypted with Securosys Hardware Security Modules (HSMs)","keywords":["cloud hsm","hsm key management","hsm cloud"]},"sidebar":"tutorialSidebar","previous":{"title":"Removing Column Encryption","permalink":"/ms-sql-ae/Tutorials/removing-column-encryption"},"next":{"title":"Concepts","permalink":"/ms-sql-ae/category/concepts"}}');var i=n(74848),r=n(28453);const a={sidebar_position:2,title:"Configuring MS SQL AE for Shared User Access with a Global CMK",sidebar_label:"Shared User Access SQL",description:"Creating a Shared Access Column Master Key for Microsoft SQL Always Encrypted with Securosys Hardware Security Modules (HSMs)",keywords:["cloud hsm","hsm key management","hsm cloud"]},l=void 0,o={},c=[{value:"Creating a Global Key with Ksputilcons",id:"creating-a-global-key-with-ksputilcons",level:2},{value:"Creating a CMK with the Global Key",id:"creating-a-cmk-with-the-global-key",level:2},{value:"Using the Global CMK",id:"using-the-global-cmk",level:2}];function d(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(s.p,{children:["In certain cases where shared access to MS SQL AE is needed, global keys can be created. These global keys can be created with the ",(0,i.jsx)(s.a,{href:"/mscng/Tutorial/KSP-utils",children:(0,i.jsx)(s.code,{children:"ksputilcons"})})," utility, where the key must have the suffix ",(0,i.jsx)(s.code,{children:".global"})," added within the name."]}),"\n",(0,i.jsxs)(s.p,{children:["When key name suffix ",(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:".global"})})," is set, the key is accessible by any authenticated user on this device, without administrative privileges. To learn more about the global key accessibility, please see our Primus HSM CNG/KSP Provider online documentation chapter ",(0,i.jsx)(s.a,{href:"/mscng/Tutorial/Key-Access",children:"Key Accessibility"}),"."]}),"\n",(0,i.jsx)(s.p,{children:"In this section we will quickly describe the steps to allow shared access to MS SQL, encrypted with a global key:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"#creating-a-global-key-with-ksputilcons",children:"Creating a Global Key with Ksputilcons"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"#creating-a-cmk-with-the-global-key",children:"Creating a CMK with the Global Key"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"#using-the-global-cmk",children:"Using the Global CMK"})}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"creating-a-global-key-with-ksputilcons",children:"Creating a Global Key with Ksputilcons"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Navigate to the folder where ",(0,i.jsx)(s.code,{children:"ksputilcons"})," is installed. By default the utility is installed within the ",(0,i.jsx)(s.code,{children:"%ProgramFiles%"})," folder: ",(0,i.jsx)(s.code,{children:'"%ProgramFiles%\\Securosys\\PrimusHsmKsp\\ksputilcons.exe"'})]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"To create a global key on the HSM that can serve as a Column Master Key in MS SQL Always Encrypted, use the command below."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"ksputilcons.exe createkey --name <keyname>.global --algorithm RSA --size 4096  \n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Rename the key as required, but ensure that it retains the \u201c.global\u201d suffix"}),"\n",(0,i.jsxs)(s.li,{children:["In order to create a CEK in MS SQL for a given CMK, the CMK requires ",(0,i.jsx)(s.strong,{children:"signing"})," and ",(0,i.jsx)(s.strong,{children:"decrypt"})," usage for a key. Therefore, either use the default setting when creating a key with ksputilcons or specify both the \u2013sign and \u2013decrypt options."]}),"\n"]}),"\n",(0,i.jsxs)(s.ol,{start:"3",children:["\n",(0,i.jsx)(s.li,{children:"You can verify the creation of the key by using the command:"}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"ksputilcons.exe enumkeys\n\nOwner: S-1-5-11 (Shared)\n------------------------\n\n+ Key name:                     <keyname>.global\n  Algorithm, size, type:        RSA, 4096 bit, PublicKey\n\n+ Key name:                     <keyname>.global\n  Algorithm, size, type:        RSA, 4096 bit, PrivateKey\n"})}),"\n",(0,i.jsx)(s.admonition,{title:"Ksputilcons Parameters and Information",type:"tip",children:(0,i.jsxs)(s.p,{children:["For more information and parameter information about the ",(0,i.jsx)(s.code,{children:"ksputilcons createkey"})," and ",(0,i.jsx)(s.code,{children:"enumkeys"})," commands, see ",(0,i.jsx)(s.a,{href:"/mscng/Tutorial/KSP-utils#create-key",children:"CNG/KSP Provider - Testing & Key Management - Create Key"}),"."]})}),"\n",(0,i.jsx)(s.h2,{id:"creating-a-cmk-with-the-global-key",children:"Creating a CMK with the Global Key"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["In MS SQL, navigate to ",(0,i.jsx)(s.strong,{children:"Always Encrypted Keys"})," -> ",(0,i.jsx)(s.strong,{children:"Column Master Keys"})," and select ",(0,i.jsx)(s.strong,{children:"New Column Master Key\u2026"})," (See ",(0,i.jsx)(s.a,{href:"/ms-sql-ae/Installation/creating-cmk",children:"Creating A Column Master Key (CMK)"})," for more information.)"]}),"\n",(0,i.jsx)(s.li,{children:"Specify the name of the CMK,"}),"\n",(0,i.jsxs)(s.li,{children:["Select the key store ",(0,i.jsx)(s.code,{children:"Key Storage Provider CNG"}),","]}),"\n",(0,i.jsxs)(s.li,{children:["Select the ",(0,i.jsx)(s.code,{children:"Securosys Primus HSM Key Storage Provider"})," provider and then select your previously created global key (in our example we use ",(0,i.jsx)(s.code,{children:"MS_SQL_AE_CMK.global"}),") from the list of keys stored on the selected KSP."]}),"\n"]}),"\n",(0,i.jsx)(s.admonition,{type:"warning",children:(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Do not"})," select ",(0,i.jsx)(s.code,{children:"Generate Key"}),", as this will trigger MS SQL to generate a CMK on the selected provider, which scope is limited to the current Windows user."]})}),"\n",(0,i.jsxs)("figure",{className:"image",children:[(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:n(73506).A+"",width:"717",height:"667"})}),(0,i.jsx)("figcaption",{children:(0,i.jsx)(s.p,{children:"Example creation of Global key as a CMK."})})]}),"\n",(0,i.jsxs)(s.ol,{start:"5",children:["\n",(0,i.jsxs)(s.li,{children:["Review your choices and click ",(0,i.jsx)(s.code,{children:"OK"})," to finish the global CMK key."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"using-the-global-cmk",children:"Using the Global CMK"}),"\n",(0,i.jsxs)(s.p,{children:["With the global CMK created proceed as normal and create a new CEK that is protected by the afore mentioned CMK and then use this new CEK to protect sensitive column data in your database. See ",(0,i.jsx)(s.a,{href:"/ms-sql-ae/Installation/creating-cek",children:"Creating A Column Encryption Key (CEK)"})," for more information."]}),"\n",(0,i.jsx)(s.p,{children:"Authenticated users that wish to access sensitive data that is protected by a CEK encrypted by a global CMK are required to have the Securosys Primus HSM KSP installed and configured access to the HSM partition in which the global key used for the CMK has been created."})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},73506:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/Global-CMK-8533d14c56ef37fd1ce2a24e8a36a2ce.png"}}]);